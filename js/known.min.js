/*! Known 2019-04-13 */
function doPoll(){Notifications.poll()}function wwwroot(){return known.config.displayUrl}function isLoggedIn(){return!("undefined"==typeof known||!known.session.loggedIn)}function base64ToArrayBuffer(a){return ImageTools.base64ToArrayBuffer(a)}function exifRotateImg(a,b,c){ImageTools.exifRotateImg(a,b,c)}function addMessage(a,b){Template.addMessage(a)}function addErrorMessage(a){Template.addErrorMessage(a)}function bindControls(){Template.bindControls()}function contentCreateForm(a,b){Template.initContentCreateForm(a,b)}function hideContentCreateForm(){Template.hideContentCreateForm()}function autoSave(a,b,c){return Template.autoSave(a,b,c)}function annotateContent(){$(".h-entry").fitVids(),$("time.dt-published").timeago()}var Security=Security||{};Security.tokens=[],Security.getCSRFToken=function(a,b){void 0==b&&(b=known.currentPageUrl);for(var c=Math.floor(Date.now()/1e3),d=0;d<Security.tokens.length;d++)Security.tokens[d].url==b&&Security.tokens[d].time>c-100&&(console.log("Returning cached token for "+b),a(Security.tokens[d].token,Security.tokens[d].time));$.ajax({type:"GET",data:{url:b},url:known.config.displayUrl+"service/security/csrftoken/"}).done(function(c,d,e){Security.tokens.push({token:c.token,time:c.time,url:b}),a(c.token,c.time)})},Security.refreshTokens=function(){$(".known-security-token").each(function(){var a=$(this).closest("form");Security.getCSRFToken(function(b,c){a.find("input[name=__bTk]").val(b),a.find("input[name=__bTs]").val(c)},a.find("input[name=__bTa]").val())})},setInterval(function(){Security.refreshTokens()},3e5),Security.activateACLControls=function(){$(".acl-ctrl-option").each(function(){$(this).data("acl")==$(this).closest(".access-control-block").find("input").val()&&$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>')}),$(".acl-ctrl-option").on("click",function(){$(this).closest(".access-control-block").find("input").val($(this).data("acl")),$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>'),$(this).closest(".btn-group").find(".dropdown-toggle").click()})},$(document).ready(function(){Security.activateACLControls()});var Logger=Logger||{};Logger.log=function(a,b){switch(void 0===b&&(b="INFO"),b.toUpperCase()){case"ALERT":case"ERROR":case"EXCEPTION":b="ERROR",console.error(b+": "+a);break;case"WARN":case"WARNING":b="WARNING",console.warn(b+": "+a);break;default:b="INFO",console.log(b+": "+a)}Security.getCSRFToken(function(c,d){$.ajax({type:"POST",data:{level:b,message:a,__bTk:c,__bTs:d},url:known.config.displayUrl+"service/system/log/"})},known.config.displayUrl+"service/system/log/")},Logger.info=function(a){Logger.log(a,"INFO")},Logger.warn=function(a){Logger.log(a,"WARN")},Logger.error=function(a){Logger.log(a,"ERROR")},Logger.deprecated=function(a){Logger.info("DEPRECATED "+a)},Logger.errorHandler=function(a){var b=a.error.stack,c=a.error.toString();b&&(c+="\n"+b),console.error(a),Logger.log(c,"ERROR")},window.addEventListener("error",function(a){Logger.errorHandler(a)});var Notifications=Notifications||{};Notifications.poll=function(){$.get(known.config.displayUrl+"service/notifications/new-notifications").done(function(a){if(a.notifications&&a.notifications.length>0)for(var b=0;b<a.notifications.length;b++){var c=a.notifications[b].title,d=a.notifications[b].body,e=a.notifications[b].icon,f=a.notifications[b].link;try{var g=new Notification(c,{icon:e,body:d,data:f});g.onclick=function(a){window.location.href=f}}catch(a){}}}).fail(function(a){})},Notifications.enable=function(a){if(known.session.loggedIn){if(!("Notification"in window))return void console.log("The Notification API is not supported by this browser");self.addEventListener("notificationclick",function(a){window.location.href=a.notification.data}),"denied"===Notification.permission||"granted"===Notification.permission||a?"granted"===Notification.permission&&setInterval(Notifications.poll,3e4):Notification.requestPermission(function(a){"granted"===a&&setInterval(Notifications.poll,3e4)})}},Notifications.isEnabled=function(){return!!known.session.loggedIn&&("Notification"in window?"granted"===Notification.permission:(console.log("The Notification API is not supported by this browser"),!1))},$(document).ready(function(){Notifications.isEnabled()&&Notifications.enable(!0)}),$(document).ready(function(){var a=$("#soft-forward").attr("href");a&&(window.location=a),known.session.loggedIn});var Unfurl=Unfurl||{};Unfurl.fetch=function(a,b){a.length>0&&Security.getCSRFToken(function(c,d){$.getJSON(known.config.displayUrl+"service/web/unfurl/",{url:a,__bTk:c,__bTs:d},function(a){b(a)})},known.config.displayUrl+"service/web/unfurl/")},Unfurl.getUrls=function(a){console.log(a);var b=new RegExp("(https?://[^\\s]+)","gi");return a.match(b)},Unfurl.getFirstUrl=function(a){var b=Unfurl.getUrls(a);return void 0!=b&&b.length>0?b[0]:""},Unfurl.initOembed=function(a){var b=a.find("div.oembed");if(void 0!=b){var c=b.attr("data-url"),d=b.attr("data-format");void 0!=c&&(console.log("Fetching oembed code from "+c+" using "+d),$.ajax({url:c,dataType:d,success:function(a){if(console.log("Got a response back"),"xml"==d){console.log("XML Format");var c=$(a),e=c.find("html").text();e.indexOf("CDATA")>-1&&(e=e.substr(9,e.length-12)),b.html(e)}else console.log("JSON Format"),b.html(a.html);b.closest(".unfurled-url").find(".basics").hide()},error:function(a){console.error("Problem fetching oembed as "+d+" trying to map a different way..."),"jsonp"==d?d="json":"json"==d&&(d="jsonp"),$.ajax({url:c,dataType:d,success:function(a){b.html(a.html),b.closest(".unfurled-url").find(".basics").hide()},error:function(a){console.error("Giving up trying to fetch oembed url "+c+" as "+d)}})}}))}},Unfurl.enableControls=function(a){var b=a.attr("data-url"),c=a.closest(".unfurl-block"),d=c.find(".unfurl-edit a.refresh"),e=c.find(".unfurl-edit a.delete");c.find(".unfurl-edit").show(),d.click(function(c){Security.getCSRFToken(function(c,d){$.ajax(known.config.displayUrl+"service/web/unfurl/",{dataType:"json",method:"GET",data:{url:b,forcenew:!0,__bTk:c,__bTs:d},success:function(b){console.log("Refreshed"),a.fadeOut().fadeIn(),Unfurl.unfurl(a)}})},known.config.displayUrl+"service/web/unfurl/"),c.preventDefault()}),e.click(function(a){Security.getCSRFToken(function(a,b){$.ajax(known.config.displayUrl+"service/web/unfurl/remove/"+c.attr("data-parent-object")+"/",{dataType:"json",method:"POST",data:{__bTk:a,__bTs:b},success:function(a){console.log("Refresh: deleted"),c.fadeOut()}})},known.config.displayUrl+"service/web/unfurl/remove/"+c.attr("data-parent-object")+"/"),a.preventDefault()})},Unfurl.unfurl=function(a){var b=a.attr("data-url");void 0!=b&&Unfurl.fetch(b,function(b){a.html(b.rendered),a.show(),Unfurl.initOembed(a),Template.enableImageFallback(),Unfurl.enableControls(a)})},Unfurl.unfurlAll=function(){$("div.unfurl").each(function(){Unfurl.unfurl($(this))})},$(document).ready(function(){Unfurl.unfurlAll()});var ImageTools=ImageTools||{};ImageTools.base64ToArrayBuffer=function(a){a=a.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var b=atob(a),c=b.length,d=new Uint8Array(c),e=0;e<c;e++)d[e]=b.charCodeAt(e);return d.buffer},ImageTools.exifRotateImg=function(a,b,c){var d,e=$(a).height(),f=$(a).width();switch(0==f&&(f=300),0==e&&(e=200),b){case 8:d=-90,$(a).css("transform-origin","0 0"),$(a).css("transform","rotate("+d+"deg)"),$(a).css("margin-left","100%"),$(c).css("width",f+"px"),$(c).css("height",f+"px");break;case 3:d=180,$(a).css("transform-origin","0 0"),$(a).css("transform","rotate("+d+"deg)");break;case 6:d=90,$(a).css("transform-origin","0 0"),$(a).css("margin-left","100%"),$(a).css("transform","rotate("+d+"deg)"),$(c).css("width",f+"px"),$(c).css("height",f+"px")}};var Template=Template||{};Template.addMessage=function(a,b){void 0===b&&(b="alert-info"),void 0!==a&&$("div#page-messages").append('<div class="alert '+b+' col-md-10 col-md-offset-1"><button type="button" class="close" data-dismiss="alert">&times;</button>'+a+"</div>")},Template.addErrorMessage=function(a){Template.addMessage(a,"alert-danger")},Template.activateStarToggle=function(){$(".interactions .annotate-icon a.stars-toggle").each(function(){var a=$(this).attr("data-form-id"),b=$(this).find("i.fa"),c=b.closest("span.annotate-icon").find("a.stars");$("#"+a).submit(function(a){a.preventDefault(),$.ajax({type:"POST",url:$(this).attr("action"),data:$(this).serialize(),success:function(a){b.hasClass("fa-star")&&b.hasClass("far")?b.removeClass("far").addClass("fas"):b.removeClass("fas").addClass("far"),c.text(a.text)}})})})},Template.enableFormCandy=function(){$(".ctrl-enter-submit").keypress(function(a){var b=a.which?a.which:a.keyCode;10!=b&&13!=b||!a.ctrlKey&&!a.metaKey||$(this).closest("form").submit()})},Template.enablePagination=function(){$(".pager-xhr a").click(function(a){a.preventDefault();var b=$(this).closest(".pager-xhr"),c=parseInt(b.attr("data-offset")),d=parseInt(b.attr("data-limit")),e=parseInt(b.attr("data-count")),f=$("#"+b.attr("data-control-id")),g=b.attr("data-source-url"),h=$(this).attr("rel"),i=$(this).closest(".pager-xhr").find("li.newer"),j=$(this).closest(".pager-xhr").find("li.older");g=g.split("?")[0];var k;"next"==h?(k=c-d)<0&&(k=0):(k=c+d)>e-1&&(k=e-1),g=g+"?offset="+k.toString()+"&limit="+d.toString(),f.load(g,function(a,c,g){"error"!=c&&(b.attr("data-offset",k.toString()),i.removeClass("pagination-disabled"),j.removeClass("pagination-disabled"),0==k&&i.addClass("pagination-disabled"),k>e-d&&j.addClass("pagination-disabled"),f.scrollTop(0))})})},Template.enableRichTextRequired=function(){$("textarea.validation-required").each(function(){var a=$(this).closest("form"),b=$(this),c=$(this).closest("div.richtext-container").find("div.alert");a.submit(function(a){c.hide(),0==b.val().length&&(a.preventDefault(),console.error("Required richtext field "+b.attr("name")+" is blank, preventing form submission"),c.show().focus())})})},Template.enableImageFallback=function(){$("img").on("error",function(){console.error("Loading fallback image "+known.config.displayUrl+"gfx/users/default.png"),$(this).attr("src",known.config.displayUrl+"gfx/users/default.png")})},Template.activateImagePreview=function(a){var b=$(a).closest("div.image-file-input").find("div.photo-preview"),c=$(a).closest("div.image-file-input").find("span.photo-filename"),d=$(a).closest("div.image-file-input").find(".preview");if(a.files&&a.files[0]){var e=new FileReader;e.onload=function(a){c.html(c.attr("data-nexttext"));try{var e=EXIF.readFromBinaryFile(base64ToArrayBuffer(this.result));ImageTools.exifRotateImg("#"+d.attr("id"),e.Orientation,"#"+b.attr("id"))}catch(a){console.error(a)}d.attr("src",a.target.result),d.show()},e.readAsDataURL(a.files[0])}},Template.autoSave=function(a,b,c){var d={};setInterval(function(){for(var e={},f=0;f<b.length;f++){var g=b[f],h="#"+g;c&&g in c&&(h=c[g]);var i=!1;$(h).val()!=d[g]&&(i=$(h).val()),!1!==i&&(e[g]=i,d[g]=i)}Object.keys(e).length>0&&$.post(wwwroot()+"autosave/",{context:a,elements:e,names:b},function(){})},1e4)},Template.isCreateFormVisible=!1,Template.bindControls=function(){$(".acl-ctrl-option").click(function(){$("#access-control-id").val($(this).attr("data-acl")),$("#acl-text").html($(this).html())}),$(".syndication-toggle input[type=checkbox]").bootstrapToggle(),$(".ignore-this").hide(),Security.activateACLControls(),Template.enableFormCandy(),Template.enableRichTextRequired(),$("#contentCreate .form-control").first().focus()},Template.initContentCreateForm=function(a,b){Template.isCreateFormVisible||(Template.isCreateFormVisible=!0,$.ajax(b,{dataType:"html",success:function(b){$("#contentCreate").html(b).slideDown(400),$("#contentTypeButtonBar").slideUp(400),window.contentCreateType=a,window.contentPage=!0,bindControls()},error:function(a){$("#contentTypeButtonBar").slideDown(400),Template.isCreateFormVisible=!1}}))},Template.hideContentCreateForm=function(){Template.isCreateFormVisible=!1,1==window.contentPage?($("#contentTypeButtonBar").slideDown(200),$("#contentCreate").slideUp(200)):window.history.length>1&&window.history.back()},function(a,b,c){if(c in b&&b[c]){var d,e=a.location,f=/^(a|html)$/i;a.addEventListener("click",function(a){for(d=a.target;!f.test(d.nodeName);)d=d.parentNode;"href"in d&&(d.href.indexOf("http")||~d.href.indexOf(e.host))&&!d.classList.contains("contentTypeButton")&&(a.preventDefault(),e.href=d.href)},!1)}}(document,window.navigator,"standalone"),$(document).ready(function(){$("body").on("click",function(a,b){var c=a.target;c.href&&-1===c.href.indexOf(window.location.origin)&&(c.target="_blank")})}),$(document).ready(function(){$.timeago.settings.cutoff=2592e6,annotateContent(),Template.enableFormCandy(),Template.enablePagination(),Template.enableRichTextRequired(),Template.enableImageFallback(),Template.activateStarToggle()});