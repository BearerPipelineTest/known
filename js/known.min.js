var Security=Security||{};Security.tokens=[],Security.getCSRFToken=function(o,i){null==i&&(i=known.currentPageUrl);for(var e=Math.floor(Date.now()/1e3),t=0;t<Security.tokens.length;t++)Security.tokens[t].url==i&&Security.tokens[t].time>e-100&&(console.log("Returning cached token for "+i),o(Security.tokens[t].token,Security.tokens[t].time));$.ajax({type:"GET",data:{url:i},url:known.config.displayUrl+"service/security/csrftoken/"}).done(function(e,t,n){Security.tokens.push({token:e.token,time:e.time,url:i}),o(e.token,e.time)})},Security.refreshTokens=function(){$(".known-security-token").each(function(){var n=$(this).closest("form");Security.getCSRFToken(function(e,t){n.find("input[name=__bTk]").val(e),n.find("input[name=__bTs]").val(t)},n.find("input[name=__bTa]").val())})},setInterval(function(){Security.refreshTokens()},3e5),Security.activateACLControls=function(){$(".acl-ctrl-option").each(function(){$(this).data("acl")==$(this).closest(".access-control-block").find("input").val()&&$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>')}),$(".acl-ctrl-option").on("click",function(){$(this).closest(".access-control-block").find("input").val($(this).data("acl")),$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>'),$(this).closest(".btn-group").find(".dropdown-toggle").click()})},$(document).ready(function(){Security.activateACLControls()});var Logger=Logger||{};Logger.log=function(n,o){switch(void 0===o&&(o="INFO"),o.toUpperCase()){case"ALERT":case"ERROR":case"EXCEPTION":o="ERROR",console.error(o+": "+n);break;case"WARN":case"WARNING":o="WARNING",console.warn(o+": "+n);break;default:o="INFO",console.log(o+": "+n)}Security.getCSRFToken(function(e,t){$.ajax({type:"POST",data:{level:o,message:n,__bTk:e,__bTs:t},url:known.config.displayUrl+"service/system/log/"})},known.config.displayUrl+"service/system/log/")},Logger.info=function(e){Logger.log(e,"INFO")},Logger.warn=function(e){Logger.log(e,"WARN")},Logger.error=function(e){Logger.log(e,"ERROR")},Logger.deprecated=function(e){Logger.info("DEPRECATED "+e)},Logger.errorHandler=function(e){var t=e.error.stack,n=e.error.toString();t&&(n+="\n"+t),console.error(e),Logger.log(n,"ERROR")},window.addEventListener("error",function(e){Logger.errorHandler(e)});var Notifications=Notifications||{};function doPoll(){Notifications.poll()}function wwwroot(){return known.config.displayUrl}function isLoggedIn(){return!("undefined"==typeof known||!known.session.loggedIn)}Notifications.poll=function(){$.get(known.config.displayUrl+"service/notifications/new-notifications").done(function(e){if(e.notifications&&0<e.notifications.length)for(var t=0;t<e.notifications.length;t++){var n=e.notifications[t].title,o=e.notifications[t].body,i=e.notifications[t].icon,a=e.notifications[t].link;try{new Notification(n,{icon:i,body:o,data:a}).onclick=function(e){window.location.href=a}}catch(e){}}}).fail(function(e){})},Notifications.enable=function(e){known.session.loggedIn&&("Notification"in window?(self.addEventListener("notificationclick",function(e){window.location.href=e.notification.data}),"denied"===Notification.permission||"granted"===Notification.permission||e?"granted"===Notification.permission&&setInterval(Notifications.poll,3e4):Notification.requestPermission(function(e){"granted"===e&&setInterval(Notifications.poll,3e4)})):console.log("The Notification API is not supported by this browser"))},Notifications.isEnabled=function(){return!!known.session.loggedIn&&("Notification"in window?"granted"===Notification.permission:(console.log("The Notification API is not supported by this browser"),!1))},$(document).ready(function(){Notifications.isEnabled()&&Notifications.enable(!0)}),$(document).ready(function(){var e=$("#soft-forward").attr("href");e&&(window.location=e),known.session.loggedIn});var Unfurl=Unfurl||{};Unfurl.fetch=function(n,o){0<n.length&&Security.getCSRFToken(function(e,t){$.getJSON(known.config.displayUrl+"service/web/unfurl/",{url:n,__bTk:e,__bTs:t},function(e){o(e)})},known.config.displayUrl+"service/web/unfurl/")},Unfurl.getUrls=function(e){console.log(e);var t=new RegExp("(https?://[^\\s]+)","gi");return e.match(t)},Unfurl.getFirstUrl=function(e){var t=Unfurl.getUrls(e);return null!=t&&0<t.length?t[0]:""},Unfurl.initOembed=function(e){var n=e.find("div.oembed");if(null!=n){var t=n.attr("data-url"),o=n.attr("data-format");null!=t&&(console.log("Fetching oembed code from "+t+" using "+o),$.ajax({url:t,dataType:o,success:function(e){if(console.log("Got a response back"),"xml"==o){console.log("XML Format");var t=$(e).find("html").text();-1<t.indexOf("CDATA")&&(t=t.substr(9,t.length-12)),n.html(t)}else console.log("JSON Format oembed"),n.html(e.html);n.closest(".unfurled-url").find(".basics").hide()},error:function(e){console.error("Problem fetching oembed as "+o+" trying to map a different way..."),"jsonp"==o?o="json":"json"==o&&(o="jsonp"),$.ajax({url:t,dataType:o,success:function(e){n.html(e.html),n.closest(".unfurled-url").find(".basics").hide()},error:function(e){console.error("Giving up trying to fetch oembed url "+t+" as "+o)}})}}))}},Unfurl.enableControls=function(n){var o=n.attr("data-url"),i=n.closest(".unfurl-block"),e=i.find(".unfurl-edit a.refresh"),t=i.find(".unfurl-edit a.delete");i.find(".unfurl-edit").show(),e.click(function(e){Security.getCSRFToken(function(e,t){$.ajax(known.config.displayUrl+"service/web/unfurl/",{dataType:"json",method:"GET",data:{url:o,forcenew:!0,__bTk:e,__bTs:t},success:function(e){console.log("Refreshed"),n.fadeOut().fadeIn(),Unfurl.unfurl(n)}})},known.config.displayUrl+"service/web/unfurl/"),e.preventDefault()}),t.click(function(e){Security.getCSRFToken(function(e,t){$.ajax(known.config.displayUrl+"service/web/unfurl/remove/"+i.attr("data-parent-object")+"/",{dataType:"json",method:"POST",data:{__bTk:e,__bTs:t},success:function(e){console.log("Refresh: deleted"),i.fadeOut()}})},known.config.displayUrl+"service/web/unfurl/remove/"+i.attr("data-parent-object")+"/"),e.preventDefault()})},Unfurl.unfurl=function(t){var e=t.attr("data-url");null!=e&&Unfurl.fetch(e,function(e){t.html(e.rendered),t.show(),Unfurl.initOembed(t),Template.enableImageFallback(),Unfurl.enableControls(t)})},Unfurl.unfurlAll=function(){$("div.unfurl").each(function(){Unfurl.unfurl($(this))})},$(document).ready(function(){Unfurl.unfurlAll()});var ImageTools=ImageTools||{};function base64ToArrayBuffer(e){return ImageTools.base64ToArrayBuffer(e)}function exifRotateImg(e,t,n){ImageTools.exifRotateImg(e,t,n)}ImageTools.base64ToArrayBuffer=function(e){e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var t=atob(e),n=t.length,o=new Uint8Array(n),i=0;i<n;i++)o[i]=t.charCodeAt(i);return o.buffer},ImageTools.exifRotateImg=function(e,t,n){var o,i=$(e).height(),a=$(e).width();switch(0==a&&(a=300),0==i&&(i=200),t){case 8:o=-90,$(e).css("transform-origin","0 0"),$(e).css("transform","rotate("+o+"deg)"),$(e).css("margin-left","100%"),$(n).css("width",a+"px"),$(n).css("height",a+"px");break;case 3:o=180,$(e).css("transform-origin","0 0"),$(e).css("transform","rotate("+o+"deg)");break;case 6:o=90,$(e).css("transform-origin","0 0"),$(e).css("margin-left","100%"),$(e).css("transform","rotate("+o+"deg)"),$(n).css("width",a+"px"),$(n).css("height",a+"px")}};var Template=Template||{};function addMessage(e,t){Template.addMessage(e)}function addErrorMessage(e){Template.addErrorMessage(e)}function bindControls(){Template.bindControls()}function contentCreateForm(e,t){Template.initContentCreateForm(e,t)}function hideContentCreateForm(){Template.hideContentCreateForm()}function autoSave(e,t,n){return Template.autoSave(e,t,n)}function annotateContent(){$(".h-entry").fitVids(),$("time.dt-published").timeago()}Template.addMessage=function(e,t){void 0===t&&(t="alert-info"),void 0!==e&&$("div#page-messages").append('<div class="alert '+t+' col-md-10 col-md-offset-1"><button type="button" class="close" data-dismiss="alert">&times;</button>'+e+"</div>")},Template.addErrorMessage=function(e){Template.addMessage(e,"alert-danger")},Template.activateStarToggle=function(){$(".interactions .annotate-icon a.stars-toggle").each(function(){var e=$(this).attr("data-form-id"),t=$(this).find("i.fa"),n=t.closest("span.annotate-icon").find("a.stars");$("#"+e).submit(function(e){e.preventDefault(),$.ajax({type:"POST",url:$(this).attr("action"),data:$(this).serialize(),success:function(e){t.hasClass("fa-star")&&t.hasClass("far")?t.removeClass("far").addClass("fas"):t.removeClass("fas").addClass("far"),n.text(e.text)}})})})},Template.enableFormCandy=function(){$(".ctrl-enter-submit").keypress(function(e){var t=e.which?e.which:e.keyCode;10!=t&&13!=t||!e.ctrlKey&&!e.metaKey||$(this).closest("form").submit()})},Template.enablePagination=function(){$(".pager-xhr a").click(function(e){e.preventDefault();var o,i=$(this).closest(".pager-xhr"),t=parseInt(i.attr("data-offset")),a=parseInt(i.attr("data-limit")),r=parseInt(i.attr("data-count")),s=$("#"+i.attr("data-control-id")),n=i.attr("data-source-url"),l=$(this).attr("rel"),c=$(this).closest(".pager-xhr").find("li.newer"),f=$(this).closest(".pager-xhr").find("li.older");n=n.split("?")[0],"next"==l?(o=t-a)<0&&(o=0):r-1<(o=t+a)&&(o=r-1),n=n+"?offset="+o.toString()+"&limit="+a.toString(),s.load(n,function(e,t,n){"error"!=t&&(i.attr("data-offset",o.toString()),c.removeClass("pagination-disabled"),f.removeClass("pagination-disabled"),0==o&&c.addClass("pagination-disabled"),r-a<o&&f.addClass("pagination-disabled"),s.scrollTop(0))})})},Template.enableRichTextRequired=function(){$("textarea.validation-required").each(function(){var e=$(this).closest("form"),t=$(this),n=$(this).closest("div.richtext-container").find("div.alert");e.submit(function(e){n.hide(),0==t.val().length&&(e.preventDefault(),console.error("Required richtext field "+t.attr("name")+" is blank, preventing form submission"),n.show().focus())})})},Template.enableImageFallback=function(){$("img").on("error",function(){console.error("Loading fallback image "+known.config.displayUrl+"gfx/users/default.png"),$(this).attr("src",known.config.displayUrl+"gfx/users/default.png")})},Template.activateImagePreview=function(e){var n=$(e).closest("div.image-file-input").find("div.photo-preview"),o=$(e).closest("div.image-file-input").find("span.photo-filename"),i=$(e).closest("div.image-file-input").find(".preview");if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){o.html(o.attr("data-nexttext"));try{var t=EXIF.readFromBinaryFile(base64ToArrayBuffer(this.result));ImageTools.exifRotateImg("#"+i.attr("id"),t.Orientation,"#"+n.attr("id"))}catch(e){console.error(e)}i.attr("src",e.target.result),i.show()},t.readAsDataURL(e.files[0])}},Template.autoSave=function(a,r,s){var l={};setInterval(function(){for(var e={},t=0;t<r.length;t++){var n=r[t],o="#"+n;s&&n in s&&(o=s[n]);var i=!1;$(o).val()!=l[n]&&(i=$(o).val()),!1!==i&&(e[n]=i,l[n]=i)}0<Object.keys(e).length&&$.post(wwwroot()+"autosave/",{context:a,elements:e,names:r},function(){})},1e4)},Template.isCreateFormVisible=!1,Template.bindControls=function(){$(".acl-ctrl-option").click(function(){$("#access-control-id").val($(this).attr("data-acl")),$("#acl-text").html($(this).html())}),$(".syndication-toggle input[type=checkbox]").bootstrapToggle(),$(".ignore-this").hide(),Security.activateACLControls(),Template.enableFormCandy(),Template.enableRichTextRequired(),$("#contentCreate .form-control").first().focus()},Template.initContentCreateForm=function(t,e){Template.isCreateFormVisible||(Template.isCreateFormVisible=!0,$.ajax(e,{dataType:"html",success:function(e){$("#contentCreate").html(e).slideDown(400),$("#contentTypeButtonBar").slideUp(400),window.contentCreateType=t,window.contentPage=!0,bindControls()},error:function(e){$("#contentTypeButtonBar").slideDown(400),Template.isCreateFormVisible=!1}}))},Template.hideContentCreateForm=function(){Template.isCreateFormVisible=!1,1==window.contentPage?($("#contentTypeButtonBar").slideDown(200),$("#contentCreate").slideUp(200)):1<window.history.length&&window.history.back()},function(e,t,n){if(n in t&&t[n]){var o,i=e.location,a=/^(a|html)$/i;e.addEventListener("click",function(e){for(o=e.target;!a.test(o.nodeName);)o=o.parentNode;"href"in o&&(o.href.indexOf("http")||~o.href.indexOf(i.host))&&!o.classList.contains("contentTypeButton")&&(e.preventDefault(),i.href=o.href)},!1)}}(document,window.navigator,"standalone"),$(document).ready(function(){$("body").on("click",function(e,t){var n=e.target;n.href&&-1===n.href.indexOf(window.location.origin)&&(n.target="_blank")})}),$(document).ready(function(){$.timeago.settings.cutoff=2592e6,annotateContent(),Template.enableFormCandy(),Template.enablePagination(),Template.enableRichTextRequired(),Template.enableImageFallback(),Template.activateStarToggle()});